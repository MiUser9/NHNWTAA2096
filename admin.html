<!DOCTYPE html>
<html lang="my">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { background: #0a0a0a; font-family: 'Myanmar Text', 'Padauk', monospace; color: white; min-height: 100vh; padding: 20px; }
        .container { max-width: 1200px; margin: 0 auto; }
        .header { text-align: center; margin-bottom: 30px; padding-bottom: 20px; border-bottom: 2px solid #ff4081; }
        .header h1 { color: #ff4081; font-size: 2em; margin-bottom: 10px; }
        .back-btn { display: inline-block; background: #ff4081; color: white; padding: 8px 16px; text-decoration: none; border-radius: 5px; margin-top: 10px; font-size: 14px; }
        .login-form { background: rgba(255, 255, 255, 0.1); padding: 30px; border-radius: 10px; max-width: 400px; margin: 50px auto; border: 1px solid #ff4081; }
        .login-form h2 { color: #ff4081; text-align: center; margin-bottom: 20px; }
        .login-input { width: 100%; padding: 12px; margin-bottom: 15px; background: rgba(255, 255, 255, 0.1); border: 1px solid #333; border-radius: 5px; color: white; font-size: 16px; }
        .login-btn { width: 100%; padding: 12px; background: #ff4081; border: none; border-radius: 5px; color: white; font-size: 16px; cursor: pointer; }
        .admin-panel { display: none; }
        .admin-panel.show { display: block; }
        .controls { display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; justify-content: center; }
        .control-btn { background: rgba(255, 64, 129, 0.3); border: 1px solid #ff4081; color: white; padding: 10px 20px; border-radius: 5px; cursor: pointer; font-size: 14px; }
        .test-btn { background: rgba(76, 175, 80, 0.3); border: 1px solid #4caf50; color: white; padding: 10px 20px; border-radius: 5px; cursor: pointer; font-size: 14px; }
        .visitors-table-container { background: rgba(255, 255, 255, 0.05); border-radius: 8px; padding: 15px; margin-top: 20px; overflow-x: auto; }
        .visitors-table { width: 100%; border-collapse: collapse; font-size: 14px; }
        .visitors-table th { background: rgba(255, 64, 129, 0.3); color: #ff4081; padding: 12px 8px; text-align: left; border-bottom: 2px solid #ff4081; font-weight: bold; }
        .visitors-table td { padding: 10px 8px; border-bottom: 1px solid #333; }
        .visitors-table tr:hover { background: rgba(255, 64, 129, 0.1); }
        .ip-cell { font-family: 'Courier New', monospace; color: #ff9800; }
        .coord-cell { font-family: 'Courier New', monospace; color: #0f0; font-size: 12px; }
        .loading { text-align: center; padding: 40px; color: #ff4081; }
        .error { text-align: center; padding: 40px; color: #ff3333; }
        .empty-state { text-align: center; padding: 40px; color: #888; }
        .table-info { color: #ccc; font-size: 14px; margin-bottom: 10px; text-align: center; }
        .test-status { padding: 10px; margin: 10px 0; border-radius: 5px; text-align: center; font-size: 14px; }
        .test-success { background: rgba(76, 175, 80, 0.2); border: 1px solid #4caf50; color: #4caf50; }
        .test-error { background: rgba(244, 67, 54, 0.2); border: 1px solid #f44336; color: #f44336; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Admin Panel - Visitor Analytics</h1>
            <a href="index.html" class="back-btn">Back to Matrix</a>
        </div>

        <div class="login-form" id="loginForm">
            <h2>Login</h2>
            <input type="password" class="login-input" id="adminPassword" placeholder="Enter password" />
            <button class="login-btn" id="loginBtn">Login</button>
        </div>

        <div class="admin-panel" id="adminPanel">
            <div class="controls">
                <button class="control-btn" onclick="loadVisitorData()">üîÑ Refresh Data</button>
                <button class="test-btn" onclick="testConnection()">üîß Test Connection</button>
                <button class="control-btn" onclick="clearAllData()">üóëÔ∏è Clear Data</button>
            </div>

            <div id="testResult" style="display: none;"></div>

            <div class="visitors-table-container">
                <div class="table-info" id="tableInfo">Enter password: <strong>visitorData</strong> and login to load data</div>
                <div id="loadingMessage" class="loading" style="display: none;">Loading visitor data from Google Sheets...</div>
                <div id="errorMessage" class="error" style="display: none;"></div>
                <div id="emptyMessage" class="empty-state" style="display: none;">No visitor data found</div>
                
                <table class="visitors-table" id="visitorsTable" style="display: none;">
                    <thead>
                        <tr>
                            <th width="180">Timestamp</th>
                            <th width="120">Country</th>
                            <th width="100">IP Address</th>
                            <th width="150">Coordinates</th>
                           
                        </tr>
                    </thead>
                    <tbody id="visitorsTableBody"></tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        const ADMIN_PASSWORD = "visitorData";
        const GOOGLE_SHEET_ID = '1Lw1eCVQq3HH5VXWeIWFDateq4rcd_bvcgqxDt3JZY4Q';
        
        let visitorData = [];

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            const loginForm = document.getElementById('loginForm');
            const adminPanel = document.getElementById('adminPanel');
            const adminPassword = document.getElementById('adminPassword');
            const loginBtn = document.getElementById('loginBtn');

            loginBtn.addEventListener('click', function() {
                if (adminPassword.value === ADMIN_PASSWORD) {
                    loginForm.style.display = 'none';
                    adminPanel.classList.add('show');
                    loadVisitorData();
                } else {
                    alert('Incorrect password. Use: visitorData');
                    adminPassword.value = '';
                }
            });

            adminPassword.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') loginBtn.click();
            });
        });

        // Test connection
        async function testConnection() {
            const testResult = document.getElementById('testResult');
            testResult.style.display = 'block';
            testResult.className = 'test-status';
            testResult.textContent = 'Testing Google Sheets connection...';
            
            try {
                const data = await loadFromGoogleSheets();
                testResult.className = 'test-status test-success';
                testResult.innerHTML = `‚úÖ Connection successful! Found ${data.length} visitor records.`;
            } catch (error) {
                testResult.className = 'test-status test-error';
                testResult.innerHTML = `‚ùå Connection failed: ${error.message}`;
            }
        }

        // Simple CSV loader
        async function loadFromGoogleSheets() {
            try {
                // Direct CSV export from Google Sheets
                const url = `https://docs.google.com/spreadsheets/d/${GOOGLE_SHEET_ID}/export?format=csv`;
                
                console.log('Loading CSV from:', url);
                const response = await fetch(url);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const csvText = await response.text();
                console.log('CSV content:', csvText);
                
                const lines = csvText.split('\n').filter(line => line.trim() !== '');
                
                if (lines.length <= 1) {
                    return [];
                }
                
                // Get headers
                const headers = lines[0].split(',').map(h => h.trim().replace(/"/g, '').toLowerCase());
                console.log('Headers:', headers);
                
                const visitors = [];
                
                // Process data rows
                for (let i = 1; i < lines.length; i++) {
                    const line = lines[i];
                    const values = parseCSVLine(line);
                    const visitor = {};
                    
                    // Map values to headers
                    for (let j = 0; j < headers.length; j++) {
                        if (j < values.length) {
                            visitor[headers[j]] = values[j].trim();
                        }
                    }
                    
                    // Ensure we have basic fields
                    if (visitor.timestamp || visitor.ip || visitor.country) {
                        visitors.push(visitor);
                    }
                }
                
                console.log('Parsed visitors:', visitors);
                return visitors;
                
            } catch (error) {
                console.error('Error loading CSV:', error);
                throw new Error(`Failed to load data: ${error.message}`);
            }
        }

        // Simple CSV line parser
        function parseCSVLine(line) {
            const result = [];
            let current = '';
            let inQuotes = false;
            
            for (let i = 0; i < line.length; i++) {
                const char = line[i];
                
                if (char === '"') {
                    inQuotes = !inQuotes;
                } else if (char === ',' && !inQuotes) {
                    result.push(current);
                    current = '';
                } else {
                    current += char;
                }
            }
            
            result.push(current);
            return result.map(val => val.replace(/^"|"$/g, '').trim());
        }

        // Load visitor data
        async function loadVisitorData() {
            const loadingMessage = document.getElementById('loadingMessage');
            const errorMessage = document.getElementById('errorMessage');
            const emptyMessage = document.getElementById('emptyMessage');
            const visitorsTable = document.getElementById('visitorsTable');
            const tableInfo = document.getElementById('tableInfo');
            
            loadingMessage.style.display = 'block';
            errorMessage.style.display = 'none';
            emptyMessage.style.display = 'none';
            visitorsTable.style.display = 'none';
            tableInfo.textContent = 'Loading data...';

            try {
                const data = await loadFromGoogleSheets();
                visitorData = data;
                
                if (visitorData.length === 0) {
                    loadingMessage.style.display = 'none';
                    emptyMessage.style.display = 'block';
                    tableInfo.textContent = 'No visitor data found in Google Sheets';
                    return;
                }
                
                updateVisitorsTable();
                
                loadingMessage.style.display = 'none';
                visitorsTable.style.display = 'table';
                tableInfo.textContent = `Showing ${visitorData.length} visitor records`;
                
            } catch (error) {
                console.error('Load error:', error);
                loadingMessage.style.display = 'none';
                errorMessage.style.display = 'block';
                errorMessage.textContent = `Failed to load data: ${error.message}`;
                tableInfo.textContent = 'Error loading data';
            }
        }

        // Update visitors table
        function updateVisitorsTable() {
            const tableBody = document.getElementById('visitorsTableBody');
            const emptyMessage = document.getElementById('emptyMessage');
            const tableInfo = document.getElementById('tableInfo');
            
            tableBody.innerHTML = '';

            if (visitorData.length === 0) {
                emptyMessage.style.display = 'block';
                tableInfo.textContent = 'No visitor data found';
                return;
            }

            emptyMessage.style.display = 'none';

            // Show latest first
            const sortedData = [...visitorData].sort((a, b) => {
                const dateA = a.timestamp ? new Date(a.timestamp) : new Date(0);
                const dateB = b.timestamp ? new Date(b.timestamp) : new Date(0);
                return dateB - dateA;
            });

            sortedData.forEach(visitor => {
                const row = document.createElement('tr');
                
                const coordinates = formatCoordinates(visitor.latitude, visitor.longitude);
                const timestamp = formatDate(visitor.timestamp);
                
                row.innerHTML = `
                    <td>${timestamp}</td>
                    <td>${visitor.country || 'Unknown'}</td>
                    <td class="ip-cell">${visitor.ip || 'Unknown'}</td>
                    <td class="coord-cell">${coordinates}</td>
                 
                `;
                tableBody.appendChild(row);
            });
        }

        // Utility functions
        function formatCoordinates(lat, lng) {
            if (!lat || !lng || lat === 'N/A' || lng === 'N/A' || lat === '' || lng === '') {
                return 'N/A';
            }
            
            try {
                const latNum = parseFloat(lat);
                const lngNum = parseFloat(lng);
                
                if (isNaN(latNum) || isNaN(lngNum)) {
                    return 'N/A';
                }
                
                return `${latNum.toFixed(4)}, ${lngNum.toFixed(4)}`;
            } catch {
                return 'N/A';
            }
        }

        function formatDate(dateString) {
            if (!dateString || dateString === '') {
                return 'Unknown';
            }
            
            try {
                const date = new Date(dateString);
                
                if (isNaN(date)) {
                    return 'Invalid Date';
                }
                
                return date.toLocaleDateString() + ' ' + date.toLocaleTimeString([], { 
                    hour: '2-digit', 
                    minute: '2-digit' 
                });
            } catch {
                return 'Invalid Date';
            }
        }

        function clearAllData() {
            if (!confirm('Clear all local data? This does not affect Google Sheets.')) {
                return;
            }
            
            visitorData = [];
            document.getElementById('visitorsTable').style.display = 'none';
            document.getElementById('emptyMessage').style.display = 'block';
            document.getElementById('tableInfo').textContent = 'No data available';
        }
    </script>
</body>
</html>
